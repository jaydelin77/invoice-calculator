<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice & Quotation Calculator</title>
    <style>
        /* ===== DESIGN SYSTEM FOUNDATION ===== */
        
        /* Import Inter font family */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            /* === COLOR PALETTE === */
            /* Primary Colors */
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-200: #bfdbfe;
            --primary-300: #93c5fd;
            --primary-400: #60a5fa;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            --primary-800: #1e40af;
            --primary-900: #1e3a8a;

            /* Neutral Colors */
            --neutral-50: #f8fafc;
            --neutral-100: #f1f5f9;
            --neutral-200: #e2e8f0;
            --neutral-300: #cbd5e1;
            --neutral-400: #94a3b8;
            --neutral-500: #64748b;
            --neutral-600: #475569;
            --neutral-700: #334155;
            --neutral-800: #1e293b;
            --neutral-900: #0f172a;

            /* Semantic Colors */
            --success-50: #f0fdf4;
            --success-100: #dcfce7;
            --success-500: #22c55e;
            --success-600: #16a34a;
            --success-700: #15803d;
            
            --error-50: #fef2f2;
            --error-100: #fee2e2;
            --error-500: #ef4444;
            --error-600: #dc2626;
            --error-700: #b91c1c;
            
            --warning-50: #fffbeb;
            --warning-100: #fef3c7;
            --warning-500: #f59e0b;
            --warning-600: #d97706;
            --warning-700: #b45309;

            /* === TYPOGRAPHY SYSTEM === */
            /* Font Families */
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-mono: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;

            /* Font Sizes */
            --text-xs: 0.75rem;      /* 12px */
            --text-sm: 0.875rem;     /* 14px */
            --text-base: 1rem;       /* 16px */
            --text-lg: 1.125rem;     /* 18px */
            --text-xl: 1.25rem;      /* 20px */
            --text-2xl: 1.5rem;      /* 24px */
            --text-3xl: 1.875rem;    /* 30px */
            --text-4xl: 2.25rem;     /* 36px */
            --text-5xl: 3rem;        /* 48px */

            /* Font Weights */
            --font-normal: 400;
            --font-medium: 500;
            --font-semibold: 600;
            --font-bold: 700;

            /* Line Heights */
            --leading-tight: 1.25;
            --leading-snug: 1.375;
            --leading-normal: 1.5;
            --leading-relaxed: 1.625;
            --leading-loose: 2;

            /* === SPACING SYSTEM === */
            /* Spacing Scale (based on 4px grid) */
            --space-0: 0;
            --space-1: 0.25rem;      /* 4px */
            --space-2: 0.5rem;       /* 8px */
            --space-3: 0.75rem;      /* 12px */
            --space-4: 1rem;         /* 16px */
            --space-5: 1.25rem;      /* 20px */
            --space-6: 1.5rem;       /* 24px */
            --space-7: 1.75rem;      /* 28px */
            --space-8: 2rem;         /* 32px */
            --space-10: 2.5rem;      /* 40px */
            --space-12: 3rem;        /* 48px */
            --space-14: 3.5rem;      /* 56px */
            --space-16: 4rem;        /* 64px */
            --space-20: 5rem;        /* 80px */
            --space-24: 6rem;        /* 96px */

            /* === BORDER RADIUS === */
            --radius-none: 0;
            --radius-sm: 0.125rem;   /* 2px */
            --radius-base: 0.25rem;  /* 4px */
            --radius-md: 0.375rem;   /* 6px */
            --radius-lg: 0.5rem;     /* 8px */
            --radius-xl: 0.75rem;    /* 12px */
            --radius-2xl: 1rem;      /* 16px */
            --radius-full: 9999px;

            /* === SHADOWS === */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-base: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

            /* === TRANSITIONS === */
            --transition-fast: 150ms ease-in-out;
            --transition-base: 200ms ease-in-out;
            --transition-slow: 300ms ease-in-out;

            /* === RESPONSIVE BREAKPOINTS === */
            --breakpoint-sm: 640px;
            --breakpoint-md: 768px;
            --breakpoint-lg: 1024px;
            --breakpoint-xl: 1280px;
            --breakpoint-2xl: 1536px;

            /* === Z-INDEX SCALE === */
            --z-dropdown: 1000;
            --z-sticky: 1020;
            --z-fixed: 1030;
            --z-modal-backdrop: 1040;
            --z-modal: 1050;
            --z-popover: 1060;
            --z-tooltip: 1070;

            /* === SEMANTIC COLOR MAPPINGS === */
            --color-brand: var(--primary-600);
            --color-brand-hover: var(--primary-700);
            --color-text-primary: var(--neutral-900);
            --color-text-secondary: var(--neutral-600);
            --color-text-muted: var(--neutral-500);
            --color-border: var(--neutral-200);
            --color-border-hover: var(--neutral-300);
            --color-background: var(--neutral-50);
            --color-surface: white;
            --color-surface-hover: var(--neutral-50);
        }

        /* === BASE STYLES === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            font-size: var(--text-base);
            line-height: var(--leading-normal);
            color: var(--neutral-800);
            background-color: var(--neutral-50);
            padding: 0;
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* === UTILITY CLASSES === */
        
        /* Typography Utilities */
        .text-xs { font-size: var(--text-xs); }
        .text-sm { font-size: var(--text-sm); }
        .text-base { font-size: var(--text-base); }
        .text-lg { font-size: var(--text-lg); }
        .text-xl { font-size: var(--text-xl); }
        .text-2xl { font-size: var(--text-2xl); }
        .text-3xl { font-size: var(--text-3xl); }
        .text-4xl { font-size: var(--text-4xl); }
        .text-5xl { font-size: var(--text-5xl); }

        .font-normal { font-weight: var(--font-normal); }
        .font-medium { font-weight: var(--font-medium); }
        .font-semibold { font-weight: var(--font-semibold); }
        .font-bold { font-weight: var(--font-bold); }

        .leading-tight { line-height: var(--leading-tight); }
        .leading-snug { line-height: var(--leading-snug); }
        .leading-normal { line-height: var(--leading-normal); }
        .leading-relaxed { line-height: var(--leading-relaxed); }

        /* Color Utilities */
        .text-primary-500 { color: var(--primary-500); }
        .text-primary-600 { color: var(--primary-600); }
        .text-primary-700 { color: var(--primary-700); }
        .text-neutral-400 { color: var(--neutral-400); }
        .text-neutral-500 { color: var(--neutral-500); }
        .text-neutral-600 { color: var(--neutral-600); }
        .text-neutral-700 { color: var(--neutral-700); }
        .text-neutral-800 { color: var(--neutral-800); }
        .text-neutral-900 { color: var(--neutral-900); }
        .text-success-600 { color: var(--success-600); }
        .text-error-600 { color: var(--error-600); }
        .text-warning-600 { color: var(--warning-600); }

        .bg-white { background-color: white; }
        .bg-neutral-50 { background-color: var(--neutral-50); }
        .bg-neutral-100 { background-color: var(--neutral-100); }
        .bg-primary-50 { background-color: var(--primary-50); }
        .bg-primary-600 { background-color: var(--primary-600); }
        .bg-success-50 { background-color: var(--success-50); }
        .bg-error-50 { background-color: var(--error-50); }
        .bg-warning-50 { background-color: var(--warning-50); }

        /* Border Utilities */
        .border-neutral-200 { border-color: var(--neutral-200); }
        .border-neutral-300 { border-color: var(--neutral-300); }
        .border-primary-500 { border-color: var(--primary-500); }
        .border-success-500 { border-color: var(--success-500); }
        .border-error-500 { border-color: var(--error-500); }

        /* Spacing Utilities */
        .p-0 { padding: var(--space-0); }
        .p-4 { padding: var(--space-4); }
        .p-6 { padding: var(--space-6); }
        .p-8 { padding: var(--space-8); }

        .m-0 { margin: var(--space-0); }
        .mb-4 { margin-bottom: var(--space-4); }
        .mb-6 { margin-bottom: var(--space-6); }
        .mb-8 { margin-bottom: var(--space-8); }

        /* Border Radius Utilities */
        .rounded-none { border-radius: var(--radius-none); }
        .rounded-sm { border-radius: var(--radius-sm); }
        .rounded { border-radius: var(--radius-base); }
        .rounded-md { border-radius: var(--radius-md); }
        .rounded-lg { border-radius: var(--radius-lg); }
        .rounded-xl { border-radius: var(--radius-xl); }

        /* Shadow Utilities */
        .shadow-sm { box-shadow: var(--shadow-sm); }
        .shadow { box-shadow: var(--shadow-base); }
        .shadow-md { box-shadow: var(--shadow-md); }
        .shadow-lg { box-shadow: var(--shadow-lg); }

        /* Transition Utilities */
        .transition { transition: all var(--transition-base); }
        .transition-fast { transition: all var(--transition-fast); }
        .transition-slow { transition: all var(--transition-slow); }

        /* === INTERACTIVE STATES === */
        
        /* Focus Ring for Accessibility */
        *:focus {
            outline: 2px solid var(--primary-500);
            outline-offset: 2px;
        }

        /* Remove default focus for mouse users */
        *:focus:not(:focus-visible) {
            outline: none;
        }

        /* Enhanced focus for keyboard users */
        *:focus-visible {
            outline: 3px solid var(--primary-500);
            outline-offset: 2px;
            box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.2);
        }

        /* Interactive Element States */
        .interactive {
            cursor: pointer;
            transition: var(--transition-base);
        }

        .interactive:hover {
            transform: translateY(-1px);
        }

        .interactive:active {
            transform: translateY(0);
        }

        /* Card Hover Effects */
        .card-hover {
            transition: var(--transition-base);
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* === LOADING AND FEEDBACK STATES === */
        
        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--neutral-300);
            border-top: 2px solid var(--primary-600);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        .spinner-sm {
            width: 16px;
            height: 16px;
            border-width: 1.5px;
        }

        .spinner-lg {
            width: 32px;
            height: 32px;
            border-width: 3px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Button Loading State */
        .btn.loading {
            position: relative;
            color: transparent;
            pointer-events: none;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Success State */
        .success-message {
            background: var(--success-50);
            color: var(--success-700);
            border: 1px solid var(--success-200);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .success-message::before {
            content: '✓';
            font-weight: var(--font-bold);
            color: var(--success-600);
        }

        /* Error State */
        .error-message {
            background: var(--error-50);
            color: var(--error-700);
            border: 1px solid var(--error-200);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .error-message::before {
            content: '⚠';
            font-weight: var(--font-bold);
            color: var(--error-600);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: var(--space-6);
            right: var(--space-6);
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--neutral-200);
            padding: var(--space-4);
            min-width: 300px;
            z-index: var(--z-tooltip);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Progress Indicator */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--neutral-200);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
            border-radius: var(--radius-full);
            transition: width 0.3s ease;
        }

        /* === SUBTLE ANIMATIONS === */
        
        /* Fade In Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Scale In Animation */
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Slide In Animation */
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Pulse Animation for Updates */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        /* Animation Classes */
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .animate-scale-in {
            animation: scaleIn 0.2s ease-out;
        }

        .animate-slide-in {
            animation: slideInLeft 0.3s ease-out;
        }

        .animate-pulse {
            animation: pulse 1s ease-out;
        }

        /* Stagger Animation for Lists */
        .line-items-table tbody tr {
            animation: fadeIn 0.3s ease-out;
        }

        .line-items-table tbody tr:nth-child(1) { animation-delay: 0.1s; }
        .line-items-table tbody tr:nth-child(2) { animation-delay: 0.2s; }
        .line-items-table tbody tr:nth-child(3) { animation-delay: 0.3s; }
        .line-items-table tbody tr:nth-child(4) { animation-delay: 0.4s; }
        .line-items-table tbody tr:nth-child(5) { animation-delay: 0.5s; }

        /* Smooth Value Changes */
        .totals-table .amount {
            transition: all 0.3s ease;
        }

        .totals-table .amount.updated {
            animation: pulse 0.6s ease-out;
        }

        /* Section Expansion */
        .expandable {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .expandable.collapsed {
            max-height: 0;
        }

        .expandable.expanded {
            max-height: 500px;
        }

        /* Micro Interactions */
        .btn:active {
            transform: translateY(1px) scale(0.98);
        }

        .form-group input:focus,
        .form-group textarea:focus {
            animation: scaleIn 0.2s ease-out;
        }

        /* Smooth Scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* === MAIN LAYOUT === */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 420px;
            height: 100vh;
            gap: 0;
            background: linear-gradient(135deg, var(--neutral-100), var(--neutral-50));
            position: relative;
        }

        .main-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-600), var(--primary-500), var(--primary-400));
            z-index: 10;
        }

        .invoice-container {
            background: white;
            border-right: 3px solid var(--neutral-200);
            overflow-y: auto;
            padding: var(--space-10);
            box-shadow: var(--shadow-xl);
            position: relative;
            margin: var(--space-4) 0 var(--space-4) var(--space-4);
            border-radius: var(--radius-xl);
            border: 1px solid var(--neutral-200);
        }

        .controls-container {
            background: linear-gradient(135deg, var(--neutral-100), var(--neutral-50));
            overflow-y: auto;
            padding: var(--space-6);
            border-left: 1px solid var(--neutral-200);
            position: relative;
            border-radius: var(--radius-xl);
            margin: var(--space-4) var(--space-4) var(--space-4) 0;
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--neutral-200);
        }

        .controls-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--success-600), var(--success-400));
            border-radius: var(--radius-full);
        }

        /* === INVOICE HEADER === */
        .invoice-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            margin-bottom: var(--space-8);
            padding-bottom: var(--space-6);
            border-bottom: 2px solid var(--neutral-200);
            gap: var(--space-6);
        }

        .logo-title-section {
            display: flex;
            align-items: flex-start;
            gap: var(--space-5);
        }

        .logo-placeholder {
            width: 96px;
            height: 96px;
            border: 3px dashed var(--neutral-300);
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--neutral-50), white);
            border-radius: var(--radius-xl);
            position: relative;
            overflow: hidden;
            transition: var(--transition-base);
            box-shadow: var(--shadow-sm);
        }

        .logo-placeholder:hover {
            border-color: var(--primary-400);
            background: linear-gradient(135deg, var(--primary-50), var(--primary-25));
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .logo-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .logo-placeholder .logo-text {
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
            color: var(--neutral-500);
            text-align: center;
            letter-spacing: 0.025em;
        }

        .document-title {
            font-size: var(--text-5xl);
            font-weight: var(--font-bold);
            background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: var(--leading-tight);
            letter-spacing: -0.025em;
            margin-top: var(--space-3);
            text-shadow: 0 2px 4px rgba(37, 99, 235, 0.1);
            position: relative;
        }

        .document-title::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-600), var(--primary-400));
            border-radius: var(--radius-full);
        }

        .company-info {
            text-align: right;
            font-size: var(--text-sm);
            padding: var(--space-4);
            background: linear-gradient(135deg, var(--neutral-50), white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--neutral-200);
            box-shadow: var(--shadow-sm);
        }

        .company-name {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            color: var(--primary-700);
            margin-bottom: var(--space-3);
            line-height: var(--leading-snug);
            letter-spacing: -0.02em;
            position: relative;
        }

        .company-name::after {
            content: '';
            position: absolute;
            bottom: -6px;
            right: 0;
            width: 40px;
            height: 2px;
            background: var(--primary-400);
            border-radius: var(--radius-full);
        }

        .company-details {
            line-height: var(--leading-relaxed);
            color: var(--neutral-600);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
        }

        .company-details div {
            margin-bottom: var(--space-1);
            padding: var(--space-1) 0;
        }

        .company-details span {
            color: var(--neutral-800);
            font-weight: var(--font-semibold);
        }

        /* === INVOICE DETAILS SECTION === */
        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-10);
            margin-bottom: var(--space-8);
            padding: var(--space-6);
            background: linear-gradient(135deg, var(--neutral-50), white);
            border-radius: var(--radius-xl);
            border: 2px solid var(--neutral-200);
            box-shadow: var(--shadow-sm);
        }

        .invoice-to-section h3,
        .job-section h3 {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--neutral-800);
            margin-bottom: var(--space-3);
            letter-spacing: -0.01em;
        }

        .customer-info,
        .job-description {
            background: transparent;
            border: 2px solid transparent;
            width: 100%;
            resize: none;
            font-family: var(--font-primary);
            font-size: var(--text-sm);
            line-height: var(--leading-relaxed);
            color: var(--neutral-700);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            transition: var(--transition-base);
        }

        .customer-info {
            min-height: 80px;
        }

        .job-description {
            min-height: 60px;
        }

        .customer-info:focus,
        .job-description:focus {
            outline: none;
            border-color: var(--primary-500);
            background: var(--primary-50);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .customer-info:hover,
        .job-description:hover {
            border-color: var(--neutral-300);
            background: var(--neutral-50);
        }

        .job-section {
            margin-top: var(--space-6);
        }

        .document-meta {
            text-align: right;
        }

        .meta-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-3);
            align-items: center;
            gap: var(--space-3);
        }

        .meta-row label {
            font-weight: var(--font-semibold);
            color: var(--neutral-800);
            min-width: 90px;
            font-size: var(--text-sm);
        }

        .meta-row span {
            color: var(--neutral-600);
            font-weight: var(--font-normal);
            font-size: var(--text-sm);
        }

        .meta-row input {
            border: 2px solid transparent;
            background: transparent;
            text-align: right;
            font-weight: var(--font-medium);
            padding: var(--space-2);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-family: var(--font-primary);
            color: var(--neutral-700);
            transition: var(--transition-base);
        }

        .meta-row input:focus {
            outline: none;
            border-color: var(--primary-500);
            background: rgba(59, 130, 246, 0.02);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .meta-row input:hover {
            border-color: var(--neutral-300);
            background: var(--neutral-50);
        }

        /* === LINE ITEMS TABLE === */
        .line-items-section {
            margin-bottom: var(--space-8);
            padding-top: var(--space-6);
            margin-top: var(--space-6);
            position: relative;
            overflow-x: auto; /* Allow horizontal scroll on mobile */
        }

        .line-items-section::before {
            content: '';
            position: absolute;
            top: -4px;
            left: 0;
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-600), var(--primary-400));
            border-radius: var(--radius-full);
        }

        .line-items-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-size: var(--text-sm);
            border: 1px solid var(--neutral-200);
            border-radius: 0;
            background: white;
        }

        .line-items-table th {
            background: var(--primary-600);
            padding: var(--space-4) var(--space-2);
            text-align: center;
            font-weight: var(--font-bold);
            color: white;
            border: 1px solid var(--primary-700);
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            line-height: 1.2;
            min-height: 58px;
            vertical-align: middle;
        }

        .line-items-table th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-600);
        }

        .line-items-table th:nth-child(1) {
            width: 8%;
            text-align: center;
        }

        .line-items-table th:nth-child(2) {
            width: 40%;
            text-align: left;
        }

        .line-items-table th:nth-child(3) {
            width: 12%;
            text-align: center;
        }

        .line-items-table th:nth-child(4) {
            width: 15%;
            text-align: center;
        }

        .line-items-table th:nth-child(5) {
            width: 15%;
            text-align: center;
        }

        .line-items-table th:nth-child(6) {
            width: 10%;
            text-align: center;
        }

        .line-items-table td {
            padding: var(--space-2) var(--space-2);
            border: 1px solid var(--neutral-200);
            background: white;
            vertical-align: middle;
            font-size: var(--text-sm);
            color: var(--neutral-700);
            transition: var(--transition-fast);
            min-height: 48px;
            line-height: 1.1;
        }

        .line-items-table tbody tr td {
            background: white;
        }

        .line-items-table tbody tr:hover td {
            background: var(--neutral-50);
        }

        .line-items-table td:nth-child(1) {
            width: 8%;
            text-align: center;
        }

        .line-items-table td:nth-child(2) {
            width: 40%;
            text-align: left;
        }

        .line-items-table td:nth-child(3) {
            width: 12%;
            text-align: center;
        }

        .line-items-table td:nth-child(4),
        .line-items-table td:nth-child(5) {
            width: 15%;
            text-align: center;
            font-weight: var(--font-medium);
            font-family: var(--font-primary);
        }

        .line-items-table td:nth-child(6) {
            width: 10%;
            text-align: center;
        }

        .line-items-table input {
            width: 100%;
            border: none;
            background: transparent;
            text-align: inherit;
            font-size: var(--text-sm);
            padding: var(--space-1);
            font-family: var(--font-primary);
            color: var(--neutral-700);
            font-weight: var(--font-medium);
            transition: var(--transition-fast);
            min-height: 32px;
            box-sizing: border-box;
        }

        .line-items-table input:focus {
            outline: 2px solid var(--primary-500);
            background: var(--primary-50);
            border-radius: var(--radius-sm);
        }

        /* Rate column display/input styling */
        .line-items-table .rate-display {
            display: inline-block;
            cursor: pointer;
            padding: var(--space-2);
            min-width: 100%;
            text-align: center;
        }

        .line-items-table .rate-input {
            display: none;
        }

        .line-items-table td:nth-child(4):hover .rate-display {
            background: var(--neutral-100);
            border-radius: var(--radius-sm);
        }

        .line-items-table td:nth-child(4).editing .rate-display {
            display: none;
        }

        .line-items-table td:nth-child(4).editing .rate-input {
            display: inline-block;
        }

        .line-items-table .action-btn {
            padding: var(--space-1) var(--space-2);
            font-size: var(--text-xs);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-bold);
            margin: 0 auto;
        }

        .add-remove-buttons {
            padding: var(--space-4) 0;
            text-align: right;
        }

        /* === PAYMENT TERMS AND TOTALS === */
        .payment-totals-section {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: var(--space-8);
            margin-top: var(--space-10);
            padding-top: var(--space-8);
            border-top: 3px solid var(--neutral-200);
            position: relative;
        }

        .payment-totals-section::before {
            content: '';
            position: absolute;
            top: -3px;
            right: 0;
            width: 120px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-400), var(--primary-600));
            border-radius: var(--radius-full);
        }

        .payment-terms {
            background: linear-gradient(135deg, var(--neutral-50), white);
            color: var(--neutral-700);
            padding: var(--space-6);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--neutral-200);
            position: relative;
            overflow: hidden;
        }

        .payment-terms::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
        }

        .payment-terms h4 {
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
            margin-bottom: var(--space-4);
            border-bottom: 2px solid var(--neutral-300);
            padding-bottom: var(--space-3);
            letter-spacing: -0.02em;
            color: var(--neutral-800);
        }

        .payment-terms-content {
            font-size: var(--text-sm);
            line-height: var(--leading-relaxed);
            text-align: justify;
            font-weight: var(--font-normal);
            color: var(--neutral-600);
        }

        .thank-you {
            text-align: center;
            margin-top: var(--space-8);
            font-style: italic;
            color: var(--neutral-600);
            font-size: var(--text-base);
            font-weight: var(--font-medium);
            padding: var(--space-4);
            background: linear-gradient(135deg, var(--neutral-50), white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--neutral-200);
            box-shadow: var(--shadow-sm);
        }

        .totals-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .totals-table {
            border-collapse: collapse;
            min-width: 300px;
            font-size: var(--text-sm);
            background: white;
            border: 1px solid var(--neutral-200);
        }

        .totals-table td {
            padding: var(--space-2) var(--space-2);
            border: 1px solid var(--neutral-200);
            min-height: 48px;
            line-height: 1.1;
            vertical-align: middle;
        }

        .totals-table .label {
            text-align: center;
            font-weight: var(--font-medium);
            color: var(--neutral-600);
            padding: var(--space-2) var(--space-2);
            min-width: 140px;
            font-size: var(--text-sm);
            text-transform: none !important;
            min-height: 48px;
            line-height: 1.1;
            vertical-align: middle;
        }

        /* Force correct capitalization for Sub Total - Maximum specificity */
        .totals-section .totals-table tr:first-child td.label {
            text-transform: none !important;
            font-variant: normal !important;
        }
        
        .totals-table tr:first-child .label {
            text-transform: none !important;
        }

        .totals-table .amount {
            text-align: center;
            font-weight: var(--font-semibold);
            color: var(--neutral-700);
            min-width: 100px;
            font-family: var(--font-primary);
            font-size: var(--text-sm);
            min-height: 48px;
            line-height: 1.1;
            vertical-align: middle;
        }

        .totals-table .total-row .label {
            font-weight: var(--font-bold);
            color: white;
            border-top: 1px solid var(--primary-600);
            padding: var(--space-2) var(--space-2);
            background: var(--primary-600);
            font-size: var(--text-lg);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            min-height: 48px;
            line-height: 1.1;
            vertical-align: middle;
        }

        .totals-table .total-row .amount {
            font-weight: var(--font-bold);
            color: white;
            font-size: var(--text-2xl);
            border-top: 1px solid var(--primary-600);
            padding: var(--space-2) var(--space-2);
            background: var(--primary-600);
            font-family: var(--font-primary);
            min-height: 48px;
            line-height: 1.1;
            vertical-align: middle;
        }

        /* === CONTROLS STYLING === */
        .control-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-5);
            box-shadow: var(--shadow-md);
            border: 2px solid var(--neutral-200);
            transition: var(--transition-base);
        }

        .control-section:hover {
            border-color: var(--primary-300);
            box-shadow: var(--shadow-lg);
            transform: translateY(-1px);
        }

        .control-section:focus-within {
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), var(--shadow-lg);
        }

        .control-section h3 {
            margin-bottom: var(--space-4);
            color: var(--neutral-800);
            border-bottom: 3px solid var(--primary-600);
            padding-bottom: var(--space-2);
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            letter-spacing: -0.01em;
        }

        .form-group {
            margin-bottom: var(--space-4);
        }

        .form-group label {
            display: block;
            font-weight: var(--font-medium);
            margin-bottom: var(--space-2);
            color: var(--neutral-700);
            font-size: var(--text-sm);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 2px solid var(--neutral-300);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-family: var(--font-primary);
            color: var(--neutral-700);
            transition: var(--transition-base);
            background: white;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: rgba(59, 130, 246, 0.02);
        }

        .form-group input:hover,
        .form-group textarea:hover,
        .form-group select:hover {
            border-color: var(--neutral-400);
        }

        /* Enhanced Input States */
        .form-group input:disabled,
        .form-group textarea:disabled,
        .form-group select:disabled {
            background-color: var(--neutral-100);
            color: var(--neutral-500);
            cursor: not-allowed;
            border-color: var(--neutral-300);
        }

        .form-group input.error,
        .form-group textarea.error {
            border-color: var(--error-500);
            background-color: var(--error-50);
        }

        .form-group input.success,
        .form-group textarea.success {
            border-color: var(--success-500);
            background-color: var(--success-50);
        }

        /* Input Group Styling */
        .input-group {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .input-group input {
            flex: 1;
        }

        /* Floating Label Enhancement */
        .form-group.floating {
            position: relative;
        }

        .form-group.floating label {
            position: absolute;
            left: var(--space-4);
            top: var(--space-3);
            transition: var(--transition-base);
            pointer-events: none;
            background: white;
            padding: 0 var(--space-1);
        }

        .form-group.floating input:focus + label,
        .form-group.floating input:not(:placeholder-shown) + label {
            top: -8px;
            font-size: var(--text-xs);
            color: var(--primary-600);
            font-weight: var(--font-medium);
        }

        /* === BUTTON SYSTEM === */
        .btn {
            padding: var(--space-3) var(--space-4);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: var(--font-medium);
            font-size: var(--text-sm);
            font-family: var(--font-primary);
            margin: var(--space-1);
            transition: var(--transition-base);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            line-height: var(--leading-tight);
        }

        .btn-primary {
            background: var(--primary-600);
            color: white;
            border-color: var(--primary-600);
        }

        .btn-primary:hover {
            background: var(--primary-700);
            border-color: var(--primary-700);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: var(--success-600);
            color: white;
            border-color: var(--success-600);
        }

        .btn-success:hover {
            background: var(--success-700);
            border-color: var(--success-700);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background: var(--error-600);
            color: white;
            border-color: var(--error-600);
        }

        .btn-danger:hover {
            background: var(--error-700);
            border-color: var(--error-700);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--neutral-600);
            color: white;
            border-color: var(--neutral-600);
            font-size: var(--text-xs);
            padding: var(--space-2) var(--space-3);
        }

        .btn-secondary:hover {
            background: var(--neutral-700);
            border-color: var(--neutral-700);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .toggle-buttons {
            display: flex;
            border: 2px solid var(--primary-600);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .toggle-btn {
            padding: var(--space-3) var(--space-5);
            background: white;
            border: none;
            cursor: pointer;
            font-weight: var(--font-medium);
            font-size: var(--text-sm);
            font-family: var(--font-primary);
            flex: 1;
            transition: var(--transition-base);
            color: var(--primary-600);
        }

        .toggle-btn.active {
            background: var(--primary-600);
            color: white;
        }

        .toggle-btn:hover:not(.active) {
            background: var(--primary-50);
            color: var(--primary-700);
        }



        /* === PROFESSIONAL PRINT STYLES === */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .controls-container {
                display: none !important;
            }

            .main-container {
                grid-template-columns: 1fr !important;
                background: white !important;
                height: auto !important;
            }

            .main-container::before {
                display: none !important;
            }

            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                font-size: 9pt !important;
                line-height: 1.2 !important;
                color: #000 !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            }

            .invoice-container {
                border: none !important;
                padding: 0.3in !important;
                box-shadow: none !important;
                margin: 0 !important;
                border-radius: 0 !important;
                background: white !important;
                max-width: 100% !important;
            }

            /* === COMPACT HEADER SECTION === */
            .invoice-header {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 0.2in !important;
                margin-bottom: 0.15in !important;
                padding-bottom: 0.1in !important;
                border-bottom: 2px solid #2563eb !important;
                background: none !important;
            }

            .logo-title-section {
                display: flex !important;
                align-items: center !important;
                gap: 0.15in !important;
            }

            /* Hide empty logo placeholder in print */
            .logo-placeholder {
                display: none !important;
            }

            /* Only show logo if there's an actual image */
            .logo-placeholder:has(img[src]:not([src=""])) {
                display: flex !important;
                width: 0.6in !important;
                height: 0.6in !important;
                border: none !important;
                background: white !important;
                border-radius: 0 !important;
                box-shadow: none !important;
            }

            .logo-placeholder img {
                width: 100% !important;
                height: 100% !important;
                object-fit: contain !important;
            }

            .add-remove-buttons {
                display: none !important;
            }



            .line-items-table th:last-child,
            .line-items-table td:last-child {
                display: none !important;
            }

            /* Hide no-print elements only in print mode */
            .no-print {
                display: none !important;
            }

            /* Fix font alignment and visibility issues */
            .payment-terms {
                background: white !important;
                color: #000 !important;
                border: 2px solid #000 !important;
                padding: 20px !important;
                border-radius: 0 !important;
                box-shadow: none !important;
            }

            .payment-terms h4 {
                color: #000 !important;
                font-weight: bold !important;
            }

            .payment-terms-content {
                color: #000 !important;
                font-size: 11px !important;
                line-height: 1.4 !important;
            }

            .company-info,
            .company-name,
            .company-details {
                color: #000 !important;
            }

            .document-title {
                color: #2563eb !important;
                font-size: 18pt !important;
                font-weight: bold !important;
                background: none !important;
                -webkit-background-clip: unset !important;
                -webkit-text-fill-color: #2563eb !important;
                text-shadow: none !important;
                margin: 0 !important;
                text-transform: uppercase !important;
                letter-spacing: 0.5pt !important;
            }

            .document-title::after {
                display: none !important;
            }

            .company-info {
                background: none !important;
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                text-align: right !important;
            }

            .company-name {
                font-size: 12pt !important;
                font-weight: bold !important;
                margin-bottom: 0.03in !important;
                color: #2563eb !important;
            }

            .company-name::after {
                display: none !important;
            }

            .company-details {
                font-size: 8pt !important;
                line-height: 1.1 !important;
                color: #000 !important;
            }

            .company-details div {
                margin-bottom: 0.01in !important;
            }

            /* === COMPACT INVOICE DETAILS === */
            .invoice-details {
                display: grid !important;
                grid-template-columns: 1.8fr 1fr !important;
                gap: 0.2in !important;
                margin-bottom: 0.1in !important;
                margin-top: 0.1in !important;
                background: none !important;
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
            }

            .invoice-to-section h3,
            .job-section h3 {
                color: #000 !important;
                font-size: 10pt !important;
                font-weight: bold !important;
                margin-bottom: 0.03in !important;
                text-transform: uppercase !important;
                letter-spacing: 0.3pt !important;
            }

            .meta-row label {
                font-weight: bold !important;
                color: #000 !important;
                font-size: 10pt !important;
                text-align: left !important;
                white-space: nowrap !important;
            }

            .customer-info,
            .job-description {
                color: #000 !important;
                border: none !important;
                padding: 0.02in 0 !important;
                background: white !important;
                font-size: 8pt !important;
                line-height: 1.1 !important;
                min-height: 0.25in !important;
                resize: none !important;
            }

            .job-section {
                margin-top: 0.08in !important;
            }

            .document-meta {
                text-align: right !important;
                width: 100% !important;
                display: block !important;
            }

            .meta-row {
                display: grid !important;
                grid-template-columns: 0.8in 1fr !important;
                gap: 0.1in !important;
                margin-bottom: 0.08in !important;
                align-items: center !important;
                width: 100% !important;
                line-height: 1.2 !important;
            }

            .meta-row:last-child {
                margin-bottom: 0 !important;
            }

            .meta-row label {
                font-weight: bold !important;
                color: #000 !important;
                font-size: 8pt !important;
                text-align: left !important;
                white-space: nowrap !important;
            }

            .meta-row span,
            .meta-row input {
                color: #000 !important;
                font-size: 8pt !important;
                border: none !important;
                background: none !important;
                text-align: right !important;
                width: 100% !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                font-weight: normal !important;
                display: block !important;
                padding: 0 !important;
                margin: 0 !important;
                line-height: 1.2 !important;
            }

            /* Completely hide date picker icon and fix date alignment */
            .meta-row input[type="date"] {
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
                appearance: none !important;
                background: none !important;
                border: none !important;
                text-align: right !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                direction: ltr !important;
                unicode-bidi: normal !important;
            }

            .meta-row input[type="date"]::-webkit-calendar-picker-indicator {
                display: none !important;
                -webkit-appearance: none !important;
                opacity: 0 !important;
                width: 0 !important;
                height: 0 !important;
                position: absolute !important;
                right: -9999px !important;
            }

            .meta-row input[type="date"]::-webkit-inner-spin-button,
            .meta-row input[type="date"]::-webkit-outer-spin-button {
                display: none !important;
                -webkit-appearance: none !important;
            }

            .meta-row input[type="date"]::-webkit-datetime-edit-fields-wrapper {
                padding: 0 !important;
            }

            .meta-row input[type="date"]::-webkit-datetime-edit {
                padding: 0 !important;
                text-align: right !important;
            }

            .meta-row input[type="date"]::-webkit-datetime-edit-text {
                padding: 0 !important;
            }

            .meta-row input[type="date"]::-webkit-datetime-edit-month-field,
            .meta-row input[type="date"]::-webkit-datetime-edit-day-field,
            .meta-row input[type="date"]::-webkit-datetime-edit-year-field {
                padding: 0 !important;
                text-align: right !important;
            }

            /* Ensure consistent alignment and formatting for all values */
            .meta-row span {
                display: block !important;
                text-align: right !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                font-size: 8pt !important;
                font-weight: normal !important;
                color: #000 !important;
                padding: 0 !important;
                margin: 0 !important;
                line-height: 1.2 !important;
            }

            .meta-row input:not([type="date"]) {
                display: block !important;
                text-align: right !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                font-size: 8pt !important;
                font-weight: normal !important;
                color: #000 !important;
                padding: 0 !important;
                margin: 0 !important;
                line-height: 1.2 !important;
            }

            .meta-row label,
            .meta-row span,
            .meta-row input {
                color: #000 !important;
            }

            .totals-table .label,
            .totals-table .amount {
                color: #000 !important;
            }

            .thank-you {
                color: #000 !important;
            }

            /* === COMPACT LINE ITEMS TABLE === */
            .line-items-section {
                border-top: 3px solid #e2e8f0 !important;
                padding-top: 0.06in !important;
                margin-top: 0.08in !important;
                margin-bottom: 0.08in !important;
                position: relative !important;
            }

            .line-items-section::before {
                display: none !important;
            }

            .line-items-table {
                width: 100% !important;
                border-collapse: collapse !important;
                border-spacing: 0 !important;
                border: 1px solid #e2e8f0 !important;
                border-radius: 0 !important;
                font-size: 7pt !important;
                margin-bottom: 0.08in !important;
                table-layout: fixed !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .line-items-table th {
                background: #2563eb !important;
                color: white !important;
                border: 1px solid #1d4ed8 !important;
                font-size: 7pt !important;
                font-weight: bold !important;
                padding: 0.04in 0.02in !important;
                text-align: center !important;
                text-transform: uppercase !important;
                letter-spacing: 0.3pt !important;
                height: 0.22in !important;
                min-height: 0.22in !important;
                max-height: 0.22in !important;
                line-height: 1.2 !important;
                vertical-align: middle !important;
                box-sizing: border-box !important;
                position: relative !important;
                overflow: hidden !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .line-items-table th:nth-child(1) { width: 6% !important; }
            .line-items-table th:nth-child(2) { 
                width: 59% !important; 
                text-align: left !important; 
            }
            .line-items-table th:nth-child(3) { width: 10% !important; }
            .line-items-table th:nth-child(4) { width: 10% !important; }
            .line-items-table th:nth-child(5) { width: 15% !important; }

            .line-items-table th::after {
                display: none !important;
                content: none !important;
                height: 0 !important;
                width: 0 !important;
                position: absolute !important;
                top: -9999px !important;
                left: -9999px !important;
            }

            .line-items-table td {
                border: 1px solid #e2e8f0 !important;
                border-top: 1px solid #e2e8f0 !important;
                border-bottom: 1px solid #e2e8f0 !important;
                border-left: 1px solid #e2e8f0 !important;
                border-right: 1px solid #e2e8f0 !important;
                color: #000 !important;
                padding: 0.02in 0.02in !important;
                font-size: 7pt !important;
                background: white !important;
                text-align: center !important;
                vertical-align: middle !important;
                line-height: 1.1 !important;
                height: 0.18in !important;
                min-height: 0.18in !important;
                max-height: 0.18in !important;
                box-sizing: border-box !important;
                position: relative !important;
                overflow: hidden !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                font-weight: normal !important;
                text-transform: none !important;
                letter-spacing: 0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .line-items-table td:nth-child(1) {
                text-align: center !important;
            }

            .line-items-table td:nth-child(2) {
                text-align: left !important;
            }

            .line-items-table td:nth-child(3) {
                text-align: center !important;
            }

            .line-items-table td:nth-child(4),
            .line-items-table td:nth-child(5) {
                text-align: center !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            }

            /* Completely hide input styling in print - make them look like plain text */
            .line-items-table input {
                text-align: center !important;
                width: 100% !important;
                border: none !important;
                outline: none !important;
                background: transparent !important;
                font-size: 7pt !important;
                padding: 0 !important;
                margin: 0 !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                font-weight: normal !important;
                vertical-align: middle !important;
                line-height: 1.1 !important;
                box-sizing: border-box !important;
                height: auto !important;
                min-height: 0 !important;
                max-height: none !important;
                display: inline !important;
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
                appearance: none !important;
                resize: none !important;
                overflow: visible !important;
                box-shadow: none !important;
                text-shadow: none !important;
                -webkit-box-shadow: none !important;
                -moz-box-shadow: none !important;
            }

            .line-items-table td:nth-child(2) input {
                text-align: left !important;
            }

            .line-items-table td:nth-child(3) input {
                text-align: center !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                font-weight: normal !important;
            }

            .line-items-table td:nth-child(4) input,
            .line-items-table td:nth-child(5) input {
                text-align: center !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            }

            /* Show formatted rate display in print, hide input */
            .line-items-table .rate-input {
                display: none !important;
            }
            
            .line-items-table .rate-display {
                display: inline-block !important;
            }

            .line-items-table tbody tr:hover td {
                background: white !important;
            }

            /* === COMPACT PAYMENT TERMS AND TOTALS === */
            .payment-totals-section {
                display: grid !important;
                grid-template-columns: 1.5fr 1fr !important;
                gap: 0.15in !important;
                margin-top: 0.08in !important;
                border-top: 2px solid #e2e8f0 !important;
                padding-top: 0.06in !important;
                position: relative !important;
            }

            .payment-totals-section::before {
                display: none !important;
            }

            .payment-terms {
                background: white !important;
                color: #000 !important;
                border: none !important;
                border-top: 1px solid #2563eb !important;
                padding: 0.04in 0 !important;
                border-radius: 0 !important;
                box-shadow: none !important;
            }

            .payment-terms::before {
                display: none !important;
            }

            .payment-terms h4 {
                color: #2563eb !important;
                font-weight: bold !important;
                font-size: 8pt !important;
                margin-bottom: 0.03in !important;
                border-bottom: none !important;
                padding-bottom: 0.01in !important;
                text-transform: uppercase !important;
                letter-spacing: 0.3pt !important;
                text-shadow: none !important;
            }

            .payment-terms-content {
                color: #000 !important;
                font-size: 6pt !important;
                line-height: 1.1 !important;
                text-align: justify !important;
                text-shadow: none !important;
            }

            .totals-section {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-end !important;
            }

            .payment-totals-section .totals-section .totals-table {
                border-collapse: collapse !important;
                border: 1px solid #e2e8f0 !important;
                font-size: 7pt !important;
                width: 100% !important;
                min-width: auto !important;
                max-width: 1.5in !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .totals-table td {
                border: 1px solid #e2e8f0 !important;
                padding: 0.02in 0.02in !important;
                font-size: 7pt !important;
                height: 0.18in !important;
                min-height: 0.18in !important;
                max-height: 0.18in !important;
                line-height: 1.1 !important;
                vertical-align: middle !important;
                box-sizing: border-box !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }



            /* Very light, subtle borders like reference image */
            .totals-table .label {
                text-align: center !important;
                font-weight: normal !important;
                color: #000 !important;
                font-size: 7pt !important;
                padding: 0.02in 0.02in !important;
                text-transform: none !important;
                border: 1px solid #e2e8f0 !important;
                border-right: 1px solid #cbd5e1 !important;
                background: white !important;
                height: 0.18in !important;
                min-height: 0.18in !important;
                max-height: 0.18in !important;
                line-height: 1.1 !important;
                vertical-align: middle !important;
                box-sizing: border-box !important;
            }

            .totals-table .amount {
                text-align: center !important;
                font-weight: normal !important;
                color: #000 !important;
                font-size: 7pt !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                border: 1px solid #e2e8f0 !important;
                height: 0.18in !important;
                min-height: 0.18in !important;
                max-height: 0.18in !important;
                line-height: 1.1 !important;
                vertical-align: middle !important;
                border-left: 1px solid #cbd5e1 !important;
                background: white !important;
                box-sizing: border-box !important;
            }



            .totals-table .total-row .label,
            .totals-table .total-row .amount {
                border: 1px solid #1e40af !important;
                background: #2563eb !important;
                color: white !important;
                font-size: 7pt !important;
                font-weight: bold !important;
                padding: 0.02in 0.02in !important;
                height: 0.18in !important;
                min-height: 0.18in !important;
                max-height: 0.18in !important;
                line-height: 1.1 !important;
                vertical-align: middle !important;
                box-sizing: border-box !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            }

            .totals-table .total-row .label {
                text-transform: uppercase !important;
                letter-spacing: 0.3pt !important;
                text-align: center !important;
            }

            .totals-table .total-row .amount {
                text-align: center !important;
            }

            /* === THANK YOU MESSAGE === */
            .thank-you {
                text-align: center !important;
                margin-top: 0.06in !important;
                font-style: italic !important;
                color: #666 !important;
                font-size: 7pt !important;
                background: none !important;
                border: none !important;
                box-shadow: none !important;
                padding: 0.02in !important;
            }

            /* === PAGE SETTINGS === */
            @page {
                margin: 0.3in;
                size: A4 portrait;
            }

            /* Prevent page breaks inside important sections */
            .invoice-header,
            .invoice-details,
            .line-items-table,
            .payment-totals-section {
                page-break-inside: avoid !important;
            }

            /* Ensure proper spacing between sections */
            .invoice-header {
                page-break-after: avoid !important;
            }

            .line-items-section {
                page-break-before: avoid !important;
                page-break-after: avoid !important;
            }

            .payment-totals-section {
                page-break-before: avoid !important;
            }

            /* Hide all animations and transitions in print */
            * {
                animation: none !important;
                transition: none !important;
                transform: none !important;
            }

            /* Ensure all backgrounds and decorative elements are hidden */
            .line-items-section::before,
            .payment-totals-section::before,
            .document-title::after,
            .company-name::after {
                display: none !important;
            }
        }

        /* === RESPONSIVE GRID SYSTEM === */
        
        /* Large screens and up (1280px+) */
        @media (min-width: 1280px) {
            .main-container {
                grid-template-columns: 1fr 440px;
            }
            
            .invoice-container {
                padding: var(--space-12);
                margin: var(--space-6) 0 var(--space-6) var(--space-6);
            }
        }

        /* Medium screens and down (1024px-) */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
                height: auto;
                min-height: 100vh;
                background: var(--neutral-50);
            }

            .invoice-container {
                border-right: none;
                border-bottom: 3px solid var(--neutral-200);
                padding: var(--space-6);
                margin: var(--space-4);
                border-radius: var(--radius-lg);
            }

            .controls-container {
                border-left: none;
                border-top: 3px solid var(--neutral-200);
                padding: var(--space-5);
                background: white;
                margin: 0 var(--space-4) var(--space-4) var(--space-4);
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-md);
            }

            .controls-container::before {
                width: 100%;
                height: 3px;
                background: linear-gradient(90deg, var(--primary-600), var(--primary-400));
            }
        }

        /* Small screens (768px-) */
        @media (max-width: 768px) {
            .invoice-container {
                padding: var(--space-4);
            }
            
            .controls-container {
                padding: var(--space-4);
            }
        }

        /* Extra small screens (640px-) */
        @media (max-width: 640px) {
            .invoice-container {
                padding: var(--space-3);
            }
            
            .controls-container {
                padding: var(--space-3);
            }

            /* Mobile table improvements */
            .line-items-table {
                font-size: var(--text-xs);
                min-width: 100%;
            }

            .line-items-table th,
            .line-items-table td {
                padding: var(--space-1) var(--space-1);
                min-height: 44px; /* Touch-friendly minimum */
            }

            .line-items-table input {
                min-height: 36px;
                font-size: var(--text-sm);
            }

            /* Make buttons more touch-friendly */
            .btn {
                min-height: 44px;
                padding: var(--space-3) var(--space-4);
            }

            /* Improve form inputs for mobile */
            .form-group input,
            .form-group textarea,
            .form-group select {
                min-height: 44px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            /* Hide print button on very small screens */
            @media (max-width: 480px) {
                .btn:contains("Print") {
                    display: none;
                }
            }
        }

        /* Hide rows dynamically when not needed */
        .totals-table tr.hidden-row {
            display: none;
        }
    </style>
</head>

<body>
    <div class="main-container">
        <!-- Left Side: Invoice Preview -->
        <div class="invoice-container">
            <!-- Invoice Header -->
            <div class="invoice-header">
                <div class="logo-title-section">
                    <div class="logo-placeholder">
                        <img id="logoImage" style="display: none;">
                        <div class="logo-text" id="logoText">Logo</div>
                    </div>
                    <div>
                        <div class="document-title" id="documentTitle">Invoice</div>
                    </div>
                </div>
                <div class="company-info">
                    <div class="company-name" id="displayCompanyName">IRONMARK LIMITED</div>
                    <div class="company-details">
                        <div>GST: <span id="displayGstNumber">124-884-594</span></div>
                        <div>E-mail: <span id="displayCompanyEmail">ironmarkinvoice@gmail.com</span></div>
                        <div>Bank Account Details: <span id="displayBankDetails">(ANZ) 01-0190-0529502-00</span></div>
                    </div>
                </div>
            </div>

            <!-- Invoice Details -->
            <div class="invoice-details">
                <div class="invoice-to-section">
                    <h3 id="invoiceToLabel">INVOICE TO:</h3>
                    <textarea class="customer-info" id="customerInfo"
                        placeholder="Enter customer details..."></textarea>

                    <div class="job-section">
                        <h3 id="jobLabel">PAINTING JOB:</h3>
                        <textarea class="job-description" id="jobDescription"
                            placeholder="Enter job description..."></textarea>
                    </div>
                </div>

                <div class="document-meta">
                    <div class="meta-row">
                        <label id="documentNumberLabel">INVOICE NO:</label>
                        <input type="text" id="documentNumber" onchange="updateDocumentNumber()"
                            style="border: none; background: transparent; text-align: right; font-weight: normal;">
                    </div>
                    <div class="meta-row">
                        <label>DATE:</label>
                        <input type="date" id="documentDate" onchange="calculateDueDate()"
                            style="border: none; background: transparent; text-align: right; font-weight: normal;">
                    </div>
                    <div class="meta-row">
                        <label>DUE DATE:</label>
                        <span id="dueDateDisplay">11/8/2025</span>
                    </div>
                </div>
            </div>

            <!-- Line Items Table -->
            <div class="line-items-section">
                <table class="line-items-table">
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>Descriptions</th>
                            <th>QTY</th>
                            <th>Rate ($)</th>
                            <th>Line Total ($)</th>
                            <th class="no-print">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="lineItemsBody">
                    </tbody>
                </table>

                <div class="add-remove-buttons">
                    <button class="btn btn-primary" onclick="addLineItem()">Add Line Item</button>
                    <button id="undoButton" class="btn btn-secondary" onclick="undoDelete()" style="display: none; margin-left: 10px;">Undo Delete</button>
                </div>
            </div>

            <!-- Payment Terms and Totals -->
            <div class="payment-totals-section">
                <div class="payment-terms">
                    <h4 id="paymentTermsHeader">Payment Terms</h4>
                    <div class="payment-terms-content" id="paymentTermsText">
                        To be paid in full within 5 days following the date of the invoice- thereafter
                        interest on the balance at 2% per month.<br><br>
                        The Account Holder is to be liable for all costs (including solicitor/sent or debt collection
                        costs and expenses) incurred by IRONMARK LIMITED, in the recovery of any sums outstanding and
                        unpaid as a result of the supply of the services and goods (if applicable).
                    </div>
                </div>

                <div class="totals-section">
                    <table class="totals-table">
                        <tr>
                            <td class="label">SUB TOTAL</td>
                            <td class="amount" id="subtotal">$0.00</td>
                        </tr>
                        <tr id="discountRow" style="display: none;" class="hidden-row">
                            <td class="label">DISCOUNT</td>
                            <td class="amount" id="totalDiscount">$0.00</td>
                        </tr>
                        <tr id="taxRow">
                            <td class="label">TAX (<span id="taxRateDisplay">15</span>%)</td>
                            <td class="amount" id="totalTax">$0.00</td>
                        </tr>
                        <tr class="total-row">
                            <td class="label">Total</td>
                            <td class="amount" id="finalTotal">$0.00</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="thank-you">
                <span id="thankYouMessage">Thank you for choosing us!</span>
            </div>
        </div>

        <!-- Right Side: Working Area -->
        <div class="controls-container">
            <!-- Action Buttons -->
            <div class="control-section">
                <button class="btn btn-success" onclick="printDocument()"
                    style="width: 100%; margin-bottom: 10px;">Print Document</button>
                <button class="btn btn-primary" onclick="newDocument()" style="width: 100%;">New Document</button>
            </div>



            <!-- 1. Document Type Toggle -->
            <div class="control-section">
                <h3>Document Type</h3>
                <div class="toggle-buttons">
                    <button class="toggle-btn active" onclick="switchDocumentType('invoice')">Invoice</button>
                    <button class="toggle-btn" onclick="switchDocumentType('quotation')">Quotation</button>
                </div>
            </div>

            <!-- 2. Tax and Discount Management -->
            <div class="control-section">
                <h3>Tax & Discount Settings</h3>
                <div class="form-group">
                    <label>Tax Rate (%):</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="taxRateInput" value="15" min="0" max="100" step="0.01"
                            onchange="updateTaxRate()" style="width: 80px;">
                        <button class="btn btn-secondary" onclick="setTaxRate(0)">No Tax</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Discount Options:</label>
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 12px; color: #666; margin-bottom: 5px; display: block;">Subtotal Percentage Discount (applied before tax):</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="discountPercent" placeholder="%" min="0" max="100" step="0.01"
                                style="width: 80px;" oninput="handlePercentageDiscountChange()" onchange="handlePercentageDiscountChange()">
                            <span style="font-size: 12px; color: #666; font-style: italic;">Auto-applied % to subtotal</span>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 12px; color: #666; margin-bottom: 5px; display: block;">Fixed Dollar Discount:</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="discountAmount" placeholder="$" min="0" step="0.01"
                                style="width: 80px;" oninput="handleFixedDiscountChange()" onchange="handleFixedDiscountChange()">
                            <span style="font-size: 12px; color: #666; font-style: italic;">Auto-applied as fixed $ amount</span>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="removeDiscounts()" style="width: 100%;">Remove All Discounts</button>
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 11px; color: #666;">
                        <strong>Note:</strong> Discounts are automatically calculated in real-time. Percentage discounts are applied to subtotal before tax calculation.
                    </div>
                </div>
            </div>

            <!-- 3. Due Date Settings -->
            <div class="control-section">
                <h3>Due Date Settings</h3>
                <div class="form-group">
                    <label id="dueDaysLabel">Days from Invoice Date:</label>
                    <input type="number" id="dueDays" value="5" min="0" max="365" onchange="updateDueDays()">
                </div>
            </div>

            <!-- 4. Payment Terms -->
            <div class="control-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 id="customMessagesHeader">Payment Terms</h3>
                    <button class="btn btn-secondary" id="editTermsBtn" onclick="toggleTermsEdit()">Edit</button>
                </div>
                <div class="form-group">
                    <label id="termsLabel">Payment Terms:</label>
                    <textarea id="customPaymentTerms" rows="4" onchange="updatePaymentTerms()"
                        disabled>To be paid in full within 5 days following the date of the invoice- thereafter interest on the balance at 2% per month. 

The Account Holder is to be liable for all costs (including solicitor/sent or debt collection costs and expenses) incurred by IRONMARK LIMITED, in the recovery of any sums outstanding and unpaid as a result of the supply of the services and goods (if applicable).</textarea>
                </div>
                <div class="form-group">
                    <label>Thank You Message:</label>
                    <textarea id="customThankYou" rows="2" onchange="updateThankYouMessage()"
                        disabled>Thank you for choosing us!</textarea>
                </div>
            </div>

            <!-- 5. Company Information -->
            <div class="control-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>Company Information</h3>
                    <button class="btn btn-secondary" id="editCompanyBtn" onclick="toggleCompanyEdit()">Edit</button>
                </div>
                <div class="form-group">
                    <label>Company Name:</label>
                    <input type="text" id="companyName" value="IRONMARK LIMITED" onchange="updateCompanyInfo()"
                        disabled>
                </div>
                <div class="form-group">
                    <label>GST Number:</label>
                    <input type="text" id="gstNumber" value="124-884-594" onchange="updateCompanyInfo()" disabled>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="companyEmail" value="ironmarkinvoice@gmail.com"
                        onchange="updateCompanyInfo()" disabled>
                </div>
                <div class="form-group">
                    <label>Bank Details:</label>
                    <input type="text" id="bankDetails" value="(ANZ) 01-0190-0529502-00" onchange="updateCompanyInfo()"
                        disabled>
                </div>
            </div>

            <!-- 6. Logo Upload -->
            <div class="control-section">
                <h3>Logo Upload</h3>
                <div class="form-group">
                    <div style="border: 2px dashed #d1d5db; padding: 20px; text-align: center; border-radius: 6px; cursor: pointer;"
                        onclick="document.getElementById('logoInputControl').click()">
                        <input type="file" id="logoInputControl" accept="image/*" onchange="uploadLogoFromControl(this)"
                            style="display: none;">
                        <img id="logoPreview" style="max-width: 100px; max-height: 100px; display: none;">
                        <div id="logoUploadText">Click to upload logo</div>
                    </div>
                    <button class="btn btn-danger" onclick="removeLogo()" style="width: 100%; margin-top: 10px;">Remove
                        Logo</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Global state
        let lineItems = [];
        let taxRate = 15;
        let documentType = 'invoice';
        let nextId = 1;
        let deletedItemsHistory = [];

        // Initialize
        initializeDocument();
        initializeLineItems();

        function initializeDocument() {
            const today = new Date();
            document.getElementById('documentDate').value = today.toISOString().split('T')[0];
            generateInvoiceNumber();
            calculateDueDate();
            updateDisplays();
        }

        function generateInvoiceNumber() {
            const today = new Date();
            const dateStr = today.getFullYear().toString() + 
                           (today.getMonth() + 1).toString().padStart(2, '0') + 
                           today.getDate().toString().padStart(2, '0');
            
            // Different prefixes for different document types
            const prefix = documentType === 'invoice' ? 'INV' : 'QUO';
            
            // Get the last used number for today and document type from localStorage
            const storageKey = `${documentType}_counter_${dateStr}`;
            let counter = parseInt(localStorage.getItem(storageKey) || '0');
            
            // Increment counter for new document
            counter++;
            
            // Save the new counter
            localStorage.setItem(storageKey, counter.toString());
            
            // Format: INV-YYYYMMDD-XX or QUO-YYYYMMDD-XX
            const documentNumber = `${prefix}-${dateStr}-${counter.toString().padStart(2, '0')}`;
            
            document.getElementById('documentNumber').value = documentNumber;
            updateDisplays();
        }

        function updateDocumentNumber() {
            updateDisplays();
        }

        function calculateDueDate() {
            const invoiceDate = new Date(document.getElementById('documentDate').value);
            const dueDays = parseInt(document.getElementById('dueDays').value) || 5;
            const dueDate = new Date(invoiceDate.getTime() + (dueDays * 24 * 60 * 60 * 1000));

            updateDisplays();
        }

        function updateDueDays() {
            const dueDays = document.getElementById('dueDays').value;
            calculateDueDate();
            updateDocumentMessage();
        }

        function updateDisplays() {
            // Update due date display
            const invoiceDate = new Date(document.getElementById('documentDate').value);
            const dueDays = parseInt(document.getElementById('dueDays').value) || 5;
            const dueDate = new Date(invoiceDate.getTime() + (dueDays * 24 * 60 * 60 * 1000));
            document.getElementById('dueDateDisplay').textContent = dueDate.toLocaleDateString();
        }

        function initializeLineItems() {
            lineItems = [
                { id: 1, description: '', quantity: 0, rate: 0.00 }
            ];
            nextId = 2;
            renderLineItems();
            updateCalculations();
        }

        // Document Type Management
        function switchDocumentType(type) {
            documentType = type;
            document.getElementById('documentTitle').textContent = type.charAt(0).toUpperCase() + type.slice(1);

            const label = type === 'invoice' ? 'INVOICE' : 'QUOTATION';
            document.getElementById('invoiceToLabel').textContent = `${label} TO:`;
            document.getElementById('documentNumberLabel').textContent = `${label} NO:`;

            // Update job label
            const jobLabel = document.getElementById('jobLabel');
            if (type === 'quotation') {
                jobLabel.textContent = 'QUOTATION JOB:';
            } else {
                jobLabel.textContent = 'PAINTING JOB:';
            }

            // Update due date settings based on document type
            const dueDaysInput = document.getElementById('dueDays');
            if (type === 'invoice') {
                dueDaysInput.value = 5; // Invoice: 5 days payment terms
            } else {
                dueDaysInput.value = 30; // Quotation: 30 days validity
            }

            // Update headers and labels in controls
            const customMessagesHeader = document.getElementById('customMessagesHeader');
            const termsLabel = document.getElementById('termsLabel');
            const paymentTermsHeader = document.getElementById('paymentTermsHeader');

            const isInvoice = type === 'invoice';
            if (customMessagesHeader) customMessagesHeader.textContent = isInvoice ? 'Payment Terms' : 'Quotation Terms';
            if (termsLabel) termsLabel.textContent = isInvoice ? 'Payment Terms:' : 'Quotation Terms:';
            if (paymentTermsHeader) paymentTermsHeader.textContent = isInvoice ? 'Payment Terms' : 'Quotation Terms';

            // Update due date label text
            const dueDaysLabel = document.getElementById('dueDaysLabel');
            if (dueDaysLabel) {
                if (isInvoice) {
                    dueDaysLabel.textContent = 'Days from Invoice Date:';
                } else {
                    dueDaysLabel.textContent = 'Days Quotation Valid:';
                }
            }

            // Generate new document number for the selected type
            generateInvoiceNumber();

            // Update toggle button states
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            updateDocumentMessage();
            calculateDueDate();
            updateDisplays();
        }

        function updateDocumentMessage() {
            const dueDays = document.getElementById('dueDays').value;
            const isInvoice = documentType === 'invoice';

            let message;
            if (isInvoice) {
                message = `To be paid in full within ${dueDays} days following the date of the invoice- thereafter interest on the balance at 2% per month.<br><br>The Account Holder is to be liable for all costs (including solicitor/sent or debt collection costs and expenses) incurred by IRONMARK LIMITED, in the recovery of any sums outstanding and unpaid as a result of the supply of the services and goods (if applicable).`;
            } else {
                message = `This quotation is valid for ${dueDays} days from the date of issue. All prices are inclusive of materials and labor. A 50% deposit is required before commencement of work.<br><br>Final payment is due upon completion of the project. Any additional work outside the scope of this quotation will be charged separately and requires written approval.`;
            }

            document.getElementById('paymentTermsText').innerHTML = message;

            // Update the custom textarea
            const customPaymentTerms = document.getElementById('customPaymentTerms');
            if (customPaymentTerms) {
                customPaymentTerms.value = message.replace(/<br><br>/g, '\n\n');
            }
        }

        // Company Info Management
        function updateCompanyInfo() {
            document.getElementById('displayCompanyName').textContent = document.getElementById('companyName').value;
            document.getElementById('displayGstNumber').textContent = document.getElementById('gstNumber').value;
            document.getElementById('displayCompanyEmail').textContent = document.getElementById('companyEmail').value;
            document.getElementById('displayBankDetails').textContent = document.getElementById('bankDetails').value;
        }

        // Logo Management
        function uploadLogoFromControl(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    // Update main logo
                    const img = document.getElementById('logoImage');
                    const text = document.getElementById('logoText');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    text.style.display = 'none';

                    // Update preview in control panel
                    const preview = document.getElementById('logoPreview');
                    const uploadText = document.getElementById('logoUploadText');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    uploadText.style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removeLogo() {
            // Remove main logo
            const img = document.getElementById('logoImage');
            const text = document.getElementById('logoText');
            img.style.display = 'none';
            text.style.display = 'block';
            img.src = '';

            // Remove preview in control panel
            const preview = document.getElementById('logoPreview');
            const uploadText = document.getElementById('logoUploadText');
            const input = document.getElementById('logoInputControl');
            preview.style.display = 'none';
            uploadText.style.display = 'block';
            preview.src = '';
            input.value = '';
        }

        // Line Items Management
        function addLineItem() {
            const lineItem = {
                id: nextId++,
                description: '',
                quantity: 0,
                rate: 0.00
            };
            lineItems.push(lineItem);
            
            // Recalculate percentage discounts when new items are added
            recalculatePercentageDiscounts();
            
            renderLineItems();
            updateCalculations();
        }

        function removeLastLineItem() {
            if (lineItems.length > 1) {
                lineItems.pop();
                renderLineItems();
                updateCalculations();
            }
        }

        function removeLineItem(id) {
            const itemToDelete = lineItems.find(item => item.id === id);
            if (itemToDelete) {
                // Store deleted item with timestamp for history
                deletedItemsHistory.push({
                    item: { ...itemToDelete },
                    timestamp: Date.now()
                });
                
                // Keep only last 10 deletions to prevent memory issues
                if (deletedItemsHistory.length > 10) {
                    deletedItemsHistory.shift();
                }
                
                // Remove the item
                lineItems = lineItems.filter(item => item.id !== id);
                
                // Remove any discounts linked to this row
                removeLinkedDiscounts(id);
                
                // Recalculate percentage discounts if any exist
                recalculatePercentageDiscounts();
                
                renderLineItems();
                updateCalculations();
                updateUndoButton();
            }
        }

        function recalculatePercentageDiscounts() {
            // Check if there's a percentage discount in the input field
            const currentPercent = parseFloat(document.getElementById('discountPercent').value);
            
            if (currentPercent > 0 && currentPercent <= 100) {
                // Remove existing percentage discounts
                lineItems = lineItems.filter(item => item.discountType !== 'percentage');
                
                // Add updated percentage discount
                const subtotal = calculatePositiveSubtotal();
                const discountAmount = subtotal * (currentPercent / 100);
                
                if (discountAmount > 0) {
                    addDiscountLineItem(`Discount (${currentPercent}%)`, -discountAmount, 'percentage');
                }
            }
        }

        function undoDelete() {
            if (deletedItemsHistory.length > 0) {
                const lastDeleted = deletedItemsHistory.pop();
                lineItems.push(lastDeleted.item);
                renderLineItems();
                updateCalculations();
                updateUndoButton();
            }
        }

        function updateUndoButton() {
            const undoBtn = document.getElementById('undoButton');
            if (undoBtn) {
                if (deletedItemsHistory.length > 0) {
                    undoBtn.style.display = 'inline-block';
                    undoBtn.textContent = `Undo Delete (${deletedItemsHistory.length})`;
                } else {
                    undoBtn.style.display = 'none';
                }
            }
        }

        function clearUndoHistory() {
            deletedItemsHistory = [];
            updateUndoButton();
        }

        // Rate editing functions
        function editRate(cell, itemId, isDiscount) {
            cell.classList.add('editing');
            const input = cell.querySelector('.rate-input');
            input.focus();
            input.select();
        }

        function updateRateFromInput(input, itemId, isDiscount) {
            const value = parseFloat(input.value) || 0;
            const finalValue = isDiscount ? -value : value;
            updateLineItem(itemId, 'rate', finalValue);
        }

        function finishRateEdit(input) {
            const cell = input.parentElement;
            cell.classList.remove('editing');
        }

        function updateLineItem(id, field, value) {
            const item = lineItems.find(item => item.id === id);
            if (item) {
                if (field === 'quantity' || field === 'rate') {
                    const numValue = parseFloat(value) || 0;
                    item[field] = numValue;
                    
                    // Always recalculate percentage discounts when any regular item changes
                    // This ensures discounts stay current with the subtotal
                    recalculatePercentageDiscounts();
                } else {
                    item[field] = value;
                }
                renderLineItems();
                updateCalculations();
            }
        }

        function renderLineItems() {
            const tbody = document.getElementById('lineItemsBody');
            tbody.innerHTML = '';

            // Separate regular items and discount items
            const regularItems = lineItems.filter(item => (item.quantity * item.rate) >= 0);
            const discountItems = lineItems.filter(item => (item.quantity * item.rate) < 0);
            
            // Combine them with discounts at the end
            const sortedItems = [...regularItems, ...discountItems];

            sortedItems.forEach((item, index) => {
                const total = item.quantity * item.rate;
                const row = document.createElement('tr');

                const isDiscount = total < 0;
                const rowStyle = isDiscount ? 'style="background-color: #fef3c7;"' : '';

                row.innerHTML = `
                    <td ${rowStyle}>${index + 1}</td>
                    <td ${rowStyle}><input type="text" value="${item.description}" onchange="updateLineItem(${item.id}, 'description', this.value)" ${isDiscount ? 'style="background-color: #fef3c7;"' : ''}></td>
                    <td ${rowStyle}><input type="number" value="${item.quantity}" step="0.01" onchange="updateLineItem(${item.id}, 'quantity', this.value)" ${isDiscount ? 'style="background-color: #fef3c7;"' : ''}></td>
                    <td ${rowStyle} onclick="editRate(this, ${item.id}, ${isDiscount})">
                        <span class="rate-display">${isDiscount ? '-$' : '$'}${formatCurrency(Math.abs(item.rate))}</span>
                        <input type="number" value="${Math.abs(item.rate)}" step="0.01" onchange="updateRateFromInput(this, ${item.id}, ${isDiscount})" onblur="finishRateEdit(this)" class="rate-input" ${isDiscount ? 'style="background-color: #fef3c7;"' : ''}>
                    </td>
                    <td ${rowStyle}>${total < 0 ? '-$' : '$'}${formatCurrency(Math.abs(total))}</td>
                    <td class="no-print"><button class="btn btn-danger action-btn" onclick="removeLineItem(${item.id})">×</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Tax Management
        function updateTaxRate() {
            taxRate = parseFloat(document.getElementById('taxRateInput').value) || 0;

            // Update tax rate display in totals
            const taxRateDisplay = document.getElementById('taxRateDisplay');
            if (taxRateDisplay) {
                taxRateDisplay.textContent = taxRate;
            }

            updateCalculations();
        }

        function setTaxRate(rate) {
            taxRate = rate;
            document.getElementById('taxRateInput').value = rate;

            // Update tax rate display in totals
            const taxRateDisplay = document.getElementById('taxRateDisplay');
            if (taxRateDisplay) {
                taxRateDisplay.textContent = rate;
            }

            updateCalculations();
        }

        // Real-time Discount Management
        function handlePercentageDiscountChange() {
            const percent = parseFloat(document.getElementById('discountPercent').value);
            
            // Remove existing percentage discounts first
            lineItems = lineItems.filter(item => 
                !(item.discountType === 'percentage')
            );
            
            if (percent > 0 && percent <= 100) {
                const subtotal = calculatePositiveSubtotal();
                const discountAmount = subtotal * (percent / 100);
                
                if (discountAmount > 0) {
                    addDiscountLineItem(`Discount (${percent}%)`, -discountAmount, 'percentage');
                }
            }
            
            renderLineItems();
            updateCalculations();
        }

        function handleFixedDiscountChange() {
            const amount = parseFloat(document.getElementById('discountAmount').value);
            
            // Remove existing fixed discounts first
            lineItems = lineItems.filter(item => 
                !(item.discountType === 'fixed')
            );
            
            if (amount > 0) {
                addDiscountLineItem('Fixed Discount', -amount, 'fixed');
                renderLineItems();
                updateCalculations();
            }
        }

        // Legacy functions for backward compatibility
        function applyPercentageDiscount() {
            handlePercentageDiscountChange();
        }

        function applyFixedDiscount() {
            handleFixedDiscountChange();
        }

        function applyRowDiscount(rowId, percent) {
            const item = lineItems.find(item => item.id === rowId);
            if (item && percent > 0 && percent <= 100) {
                const originalAmount = item.quantity * item.rate;
                const discountAmount = originalAmount * (percent / 100);
                addDiscountLineItem(`Row ${rowId} Discount (${percent}%)`, -discountAmount, 'row', rowId);
            }
        }

        function addDiscountLineItem(description, amount, type = 'fixed', linkedRowId = null) {
            const lineItem = {
                id: nextId++,
                description: description,
                quantity: 1,
                rate: amount,
                discountType: type,
                linkedRowId: linkedRowId
            };
            lineItems.push(lineItem);
            // Don't auto-render here, let calling function handle it
        }

        function removeDiscounts() {
            lineItems = lineItems.filter(item => !item.discountType);
            
            // Clear discount input fields
            document.getElementById('discountPercent').value = '';
            document.getElementById('discountAmount').value = '';
            
            renderLineItems();
            updateCalculations();
        }

        function removeLinkedDiscounts(deletedRowId) {
            // Remove any discounts linked to the deleted row
            lineItems = lineItems.filter(item => item.linkedRowId !== deletedRowId);
        }

        function calculatePositiveSubtotal() {
            return lineItems.reduce((sum, item) => {
                // Only include items that are not discounts (positive amounts)
                const itemTotal = item.quantity * item.rate;
                if (itemTotal > 0 && !item.discountType) {
                    return sum + itemTotal;
                }
                return sum;
            }, 0);
        }

        // Calculations
        function calculateSubtotal() {
            // This calculates the net subtotal (including discounts)
            return lineItems.reduce((sum, item) => {
                const itemTotal = item.quantity * item.rate;
                return sum + itemTotal;
            }, 0);
        }

        function calculateDiscountAmount() {
            return lineItems.reduce((sum, item) => {
                const itemTotal = item.quantity * item.rate;
                return itemTotal < 0 ? sum + Math.abs(itemTotal) : sum;
            }, 0);
        }

        function calculateTax(subtotal) {
            // Tax should be calculated on the subtotal after discounts are applied
            const taxableAmount = subtotal; // This is already the net amount after discounts
            return taxableAmount * (taxRate / 100);
        }

        function updateCalculations() {
            const grossSubtotal = calculatePositiveSubtotal(); // Only positive items
            const discountAmount = calculateDiscountAmount(); // Total discount amount
            const netSubtotal = grossSubtotal - discountAmount; // Subtotal after discounts
            const tax = calculateTax(netSubtotal); // Tax on discounted amount
            const total = netSubtotal + tax;

            // Update values - show gross subtotal in the subtotal line
            document.getElementById('subtotal').textContent = '$' + formatCurrency(grossSubtotal);
            document.getElementById('totalTax').textContent = '$' + formatCurrency(tax);
            document.getElementById('finalTotal').textContent = '$' + formatCurrency(total);

            // Dynamic discount row visibility
            const discountRow = document.getElementById('discountRow');
            const discountDisplay = document.getElementById('totalDiscount');
            if (discountAmount > 0) {
                discountRow.style.display = 'table-row';
                discountRow.classList.remove('hidden-row');
                discountDisplay.textContent = '$' + formatCurrency(discountAmount);
            } else {
                discountRow.style.display = 'none';
                discountRow.classList.add('hidden-row');
            }
        }

        // Custom Messages
        function updatePaymentTerms() {
            const paymentTermsText = document.getElementById('paymentTermsText');
            const customPaymentTerms = document.getElementById('customPaymentTerms');
            if (paymentTermsText && customPaymentTerms) {
                paymentTermsText.innerHTML = customPaymentTerms.value.replace(/\n/g, '<br>');
            }
        }

        function updateThankYouMessage() {
            const thankYouMessage = document.getElementById('thankYouMessage');
            const customThankYou = document.getElementById('customThankYou');
            if (thankYouMessage && customThankYou) {
                thankYouMessage.textContent = customThankYou.value;
            }
        }

        // Utility functions
        function formatCurrency(amount) {
            return Math.abs(amount).toFixed(2);
        }

        function newDocument() {
            if (confirm('Are you sure you want to create a new document? This will clear all current data.')) {
                lineItems = [];
                nextId = 1;
                taxRate = 15;
                clearUndoHistory();

                document.getElementById('customerInfo').value = '';
                document.getElementById('jobDescription').value = '';
                document.getElementById('discountPercent').value = '';
                document.getElementById('discountAmount').value = '';
                document.getElementById('taxRateInput').value = '15';
                document.getElementById('dueDays').value = '5';

                generateInvoiceNumber();
                document.getElementById('documentDate').value = new Date().toISOString().split('T')[0];
                calculateDueDate();

                initializeLineItems();
            }
        }

        function printDocument() {
            // Get the current document number for the filename
            const documentNumber = document.getElementById('documentNumber').value;
            const originalTitle = document.title;
            
            // Set the document title to the invoice/quotation number for PDF filename
            if (documentNumber) {
                document.title = documentNumber;
            }
            
            // Print the document
            window.print();
            
            // Restore the original title after a short delay
            setTimeout(() => {
                document.title = originalTitle;
            }, 1000);
        }

        // Edit/Save functionality
        function toggleTermsEdit() {
            const textarea1 = document.getElementById('customPaymentTerms');
            const textarea2 = document.getElementById('customThankYou');
            const btn = document.getElementById('editTermsBtn');

            if (textarea1.disabled) {
                textarea1.disabled = false;
                textarea2.disabled = false;
                btn.textContent = 'Save';
                btn.className = 'btn btn-success';
            } else {
                textarea1.disabled = true;
                textarea2.disabled = true;
                btn.textContent = 'Edit';
                btn.className = 'btn btn-secondary';
                updatePaymentTerms();
                updateThankYouMessage();
            }
        }

        function toggleCompanyEdit() {
            const inputs = ['companyName', 'gstNumber', 'companyEmail', 'bankDetails'];
            const btn = document.getElementById('editCompanyBtn');
            const firstInput = document.getElementById(inputs[0]);

            if (firstInput.disabled) {
                inputs.forEach(id => document.getElementById(id).disabled = false);
                btn.textContent = 'Save';
                btn.className = 'btn btn-success';
            } else {
                inputs.forEach(id => document.getElementById(id).disabled = true);
                btn.textContent = 'Edit';
                btn.className = 'btn btn-secondary';
                updateCompanyInfo();
            }
        }
    </script>
</body>

</html>